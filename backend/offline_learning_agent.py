#!/usr/bin/env python3
"""
Offline Learning Agent
Handles offline study sessions using pre-generated learning packs.
"""

import json
import os
from datetime import datetime
from typing import Dict, List, Any, Optional

class OfflineLearningAgent:
    """Handles offline learning sessions using learning packs"""
    
    def __init__(self, learning_pack_path: str = None):
        self.learning_pack = None
        self.current_question = 0
        self.quiz_answers = []
        self.study_progress = 0
        
        if learning_pack_path:
            self.load_learning_pack(learning_pack_path)
    
    def load_learning_pack(self, file_path: str) -> bool:
        """Load learning pack from JSON file"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                self.learning_pack = json.load(f)
            
            print(f"‚úÖ Learning pack loaded: {self.learning_pack['pack_info']['title']}")
            return True
            
        except Exception as e:
            print(f"‚ùå Error loading learning pack: {e}")
            return False
    
    def get_pack_info(self) -> Dict[str, Any]:
        """Get basic information about the loaded learning pack"""
        if not self.learning_pack:
            return {"error": "No learning pack loaded"}
        
        return {
            "title": self.learning_pack["pack_info"]["title"],
            "subject": self.learning_pack["pack_info"]["subject"],
            "chapter": self.learning_pack["pack_info"]["chapter_number"],
            "created": self.learning_pack["pack_info"]["created_date"],
            "expires": self.learning_pack["pack_info"]["expires_date"],
            "status": self.learning_pack["pack_info"]["status"]
        }
    
    def start_study_session(self) -> str:
        """Start a new study session"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded. Please load a learning pack first."
        
        pack_info = self.learning_pack["pack_info"]
        study_material = self.learning_pack["study_material"]
        
        welcome_message = f"""
üìö Welcome to your offline study session!

üìñ Subject: {pack_info['subject']}
üìù Chapter: {pack_info['chapter_number']}
üéØ Title: {study_material['title']}

üìã What you'll learn today:
{chr(10).join([f"‚Ä¢ {concept}" for concept in study_material['key_concepts']])}

üí° Commands available:
‚Ä¢ 'study' - Read the study material
‚Ä¢ 'quiz' - Take the assessment quiz
‚Ä¢ 'summary' - Get chapter summary
‚Ä¢ 'progress' - Check your progress
‚Ä¢ 'help' - Show available commands

Ready to start learning! Type 'study' to begin.
        """
        
        return welcome_message.strip()
    
    def get_study_material(self) -> str:
        """Get the study material content"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        study_material = self.learning_pack["study_material"]
        
        content = f"""
üìñ {study_material['title']}

üìã Overview:
{study_material['overview']}

üéØ Key Concepts:
{chr(10).join([f"‚Ä¢ {concept}" for concept in study_material['key_concepts']])}

üìö Detailed Content:
{study_material['detailed_content']}

üí° Examples:
{chr(10).join([f"‚Ä¢ {example}" for example in study_material['examples']])}

üìù Summary:
{study_material['summary']}

‚úÖ Study material completed! Type 'quiz' to take the assessment.
        """
        
        self.study_progress = 100
        return content.strip()
    
    def start_quiz(self) -> str:
        """Start the assessment quiz"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        assessment = self.learning_pack["assessment"]
        self.current_question = 0
        self.quiz_answers = []
        
        return f"""
üß† Assessment Quiz: {assessment['quiz_title']}

üìä Quiz Information:
‚Ä¢ Total Questions: {assessment['total_questions']}
‚Ä¢ Passing Score: {assessment['passing_score']}%
‚Ä¢ Time: Take your time, no rush!

Type 'next' to start the first question.
        """.strip()
    
    def get_next_question(self) -> str:
        """Get the next quiz question"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        assessment = self.learning_pack["assessment"]
        
        if self.current_question >= assessment["total_questions"]:
            return self.get_quiz_results()
        
        question = assessment["questions"][self.current_question]
        
        question_text = f"""
‚ùì Question {self.current_question + 1} of {assessment['total_questions']}

{question['question']}

A) {question['options'][0]}
B) {question['options'][1]}
C) {question['options'][2]}
D) {question['options'][3]}

Type your answer: A, B, C, or D
        """
        
        return question_text.strip()
    
    def submit_answer(self, answer: str) -> str:
        """Submit an answer to the current question"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        assessment = self.learning_pack["assessment"]
        
        if self.current_question >= assessment["total_questions"]:
            return "‚ùå No more questions. Type 'results' to see your score."
        
        # Convert answer to index
        answer_map = {'A': 0, 'B': 1, 'C': 2, 'D': 3}
        answer_index = answer_map.get(answer.upper(), -1)
        
        if answer_index == -1:
            return "‚ùå Invalid answer. Please type A, B, C, or D."
        
        question = assessment["questions"][self.current_question]
        is_correct = answer_index == question["correct_answer"]
        
        # Store the answer
        self.quiz_answers.append({
            "question_id": question["id"],
            "user_answer": answer_index,
            "correct_answer": question["correct_answer"],
            "is_correct": is_correct
        })
        
        # Move to next question
        self.current_question += 1
        
        if is_correct:
            response = "‚úÖ Correct! Well done!"
        else:
            correct_option = chr(65 + question["correct_answer"])  # A, B, C, or D
            response = f"‚ùå Incorrect. The correct answer is {correct_option}."
        
        response += f"\nüí° Explanation: {question['explanation']}"
        
        if self.current_question < assessment["total_questions"]:
            response += "\n\nType 'next' for the next question."
        else:
            response += "\n\nüéâ Quiz completed! Type 'results' to see your final score."
        
        return response
    
    def get_quiz_results(self) -> str:
        """Get the final quiz results"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        if not self.quiz_answers:
            return "‚ùå No quiz answers found. Start a quiz first."
        
        assessment = self.learning_pack["assessment"]
        total_questions = len(self.quiz_answers)
        correct_answers = sum(1 for answer in self.quiz_answers if answer["is_correct"])
        score_percentage = (correct_answers / total_questions) * 100
        passed = score_percentage >= assessment["passing_score"]
        
        # Update progress in learning pack
        self.learning_pack["progress"]["completed"] = True
        self.learning_pack["progress"]["score"] = score_percentage
        self.learning_pack["progress"]["last_accessed"] = datetime.now().isoformat()
        
        results = f"""
üéâ Quiz Results

üìä Your Score: {correct_answers}/{total_questions} ({score_percentage:.1f}%)
üéØ Passing Score: {assessment['passing_score']}%
{'‚úÖ Congratulations! You passed!' if passed else '‚ùå You need to study more. Try again!'}

üìã Question Breakdown:
        """
        
        for i, answer in enumerate(self.quiz_answers):
            status = "‚úÖ" if answer["is_correct"] else "‚ùå"
            user_choice = chr(65 + answer["user_answer"])
            correct_choice = chr(65 + answer["correct_answer"])
            results += f"\n{status} Question {i+1}: You chose {user_choice}, Correct was {correct_choice}"
        
        if passed:
            results += "\n\nüéì Great job! You've mastered this chapter!"
        else:
            results += f"\n\nüìö Don't worry! Review the material and try again. You need {assessment['passing_score']}% to pass."
        
        return results.strip()
    
    def get_summary(self) -> str:
        """Get chapter summary"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        study_material = self.learning_pack["study_material"]
        
        return f"""
üìù Chapter Summary: {study_material['title']}

üéØ Key Concepts Covered:
{chr(10).join([f"‚Ä¢ {concept}" for concept in study_material['key_concepts']])}

üìö Summary:
{study_material['summary']}

üí° Examples:
{chr(10).join([f"‚Ä¢ {example}" for example in study_material['examples']])}

‚úÖ You've completed this chapter! Great work!
        """.strip()
    
    def get_progress(self) -> str:
        """Get current progress"""
        if not self.learning_pack:
            return "‚ùå No learning pack loaded."
        
        progress = self.learning_pack["progress"]
        
        progress_text = f"""
üìä Your Progress

üìñ Study Material: {'‚úÖ Completed' if self.study_progress == 100 else f'‚è≥ {self.study_progress}% Complete'}
üß† Quiz: {'‚úÖ Completed' if progress['completed'] else '‚è≥ Not Started'}
üìä Quiz Score: {progress['score'] if progress['score'] is not None else 'Not taken yet'}
‚è∞ Last Accessed: {progress['last_accessed'] if progress['last_accessed'] else 'Never'}

üí° Commands:
‚Ä¢ 'study' - Continue studying
‚Ä¢ 'quiz' - Take the quiz
‚Ä¢ 'summary' - Get summary
        """
        
        return progress_text.strip()
    
    def save_progress(self, file_path: str = None) -> bool:
        """Save progress back to learning pack file"""
        if not self.learning_pack:
            return False
        
        if not file_path:
            pack_id = self.learning_pack["pack_info"]["pack_id"]
            file_path = f"/Users/mac/tutor_agent/backend/learning_pack_{pack_id}.json"
        
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(self.learning_pack, f, indent=2, ensure_ascii=False)
            
            print(f"‚úÖ Progress saved to: {file_path}")
            return True
            
        except Exception as e:
            print(f"‚ùå Error saving progress: {e}")
            return False
    
    def handle_command(self, user_input: str) -> str:
        """Handle user commands for offline learning"""
        command = user_input.lower().strip()
        
        if command == "help":
            return """
üìö Offline Learning Commands:

üìñ Study Commands:
‚Ä¢ 'study' - Read the study material
‚Ä¢ 'summary' - Get chapter summary
‚Ä¢ 'progress' - Check your progress

üß† Quiz Commands:
‚Ä¢ 'quiz' - Start the assessment quiz
‚Ä¢ 'next' - Get next question (during quiz)
‚Ä¢ 'results' - See quiz results

üí° General:
‚Ä¢ 'info' - Show learning pack information
‚Ä¢ 'help' - Show this help message
            """.strip()
        
        elif command == "study":
            return self.get_study_material()
        
        elif command == "quiz":
            return self.start_quiz()
        
        elif command == "next":
            return self.get_next_question()
        
        elif command == "results":
            return self.get_quiz_results()
        
        elif command == "summary":
            return self.get_summary()
        
        elif command == "progress":
            return self.get_progress()
        
        elif command == "info":
            info = self.get_pack_info()
            if "error" in info:
                return info["error"]
            
            return f"""
üìö Learning Pack Information

üìñ Title: {info['title']}
üìù Subject: {info['subject']}
üìä Chapter: {info['chapter']}
üìÖ Created: {info['created']}
‚è∞ Expires: {info['expires']}
‚úÖ Status: {info['status']}
            """.strip()
        
        elif command in ['a', 'b', 'c', 'd']:
            return self.submit_answer(command)
        
        else:
            return """
‚ùì I didn't understand that command.

Type 'help' to see available commands, or try:
‚Ä¢ 'study' - Read study material
‚Ä¢ 'quiz' - Take assessment
‚Ä¢ 'progress' - Check progress
            """.strip()

# Example usage
def main():
    """Example of using the offline learning agent"""
    agent = OfflineLearningAgent()
    
    # Load a learning pack
    pack_path = "/Users/mac/tutor_agent/backend/learning_pack_math_ch001.json"
    
    if agent.load_learning_pack(pack_path):
        print(agent.start_study_session())
        
        # Example interaction
        print("\n" + "="*50)
        print(agent.handle_command("study"))
        print("\n" + "="*50)
        print(agent.handle_command("quiz"))
        print("\n" + "="*50)
        print(agent.handle_command("next"))

if __name__ == "__main__":
    main()
